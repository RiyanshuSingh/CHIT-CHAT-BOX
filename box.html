<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chatbox App with Login/Signup</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #f4f4f4;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      .hidden {
        display: none;
      }

      /* Login/Signup card */
      .auth-container {
        width: 350px;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      .auth-container h2 {
        text-align: center;
      }
      .auth-container input {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .auth-container button {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        border: none;
        border-radius: 5px;
        background: #0078ff;
        color: white;
        cursor: pointer;
      }
      .auth-container p {
        text-align: center;
      }
      #toggleAuth {
        color: #0078ff;
        cursor: pointer;
      }

      /* Chat UI */
      .chat-container {
        display: flex;
        width: 800px;
        height: 500px;
        border-radius: 10px;
        overflow: hidden;
        background: white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      .chat-contacts {
        width: 250px;
        border-right: 1px solid #ddd;
        display: flex;
        flex-direction: column;
      }
      .chat-contacts input {
        padding: 10px;
        border: none;
        border-bottom: 1px solid #ddd;
        outline: none;
      }
      .chat-contacts-list {
        flex: 1;
        overflow-y: auto;
      }
      .chat-contact {
        display: flex;
        align-items: center;
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
      }
      .chat-contact.active {
        background: #f0f8ff;
      }
      .contact-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #0078ff;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-right: 10px;
        font-weight: bold;
      }
      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .chat-header {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        display: flex;
        align-items: center;
        background: #f9f9f9;
      }
      .chat-header .contact-avatar {
        margin-right: 10px;
      }
      .chat-messages {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
        background: #fafafa;
        display: flex;
        flex-direction: column;
      }
      .message {
        margin: 5px 0;
        padding: 8px 12px;
        border-radius: 15px;
        max-width: 70%;
        word-wrap: break-word;
      }
      .message-sent {
        background: #0078ff;
        color: white;
        align-self: flex-end;
      }
      .message-received {
        background: #e5e5ea;
        color: black;
        align-self: flex-start;
      }
      .chat-footer {
        display: flex;
        border-top: 1px solid #ddd;
      }
      .chat-footer input {
        flex: 1;
        padding: 10px;
        border: none;
        outline: none;
      }
      .chat-footer button {
        padding: 10px 15px;
        border: none;
        background: #0078ff;
        color: white;
        cursor: pointer;
      }
      #toppingheader {
        position: fixed; /* stays at the top even when scrolling */
        top: 0;
        left: 0;
        width: 100%;
        background: #0078ff;
        color: white;
        text-align: center;
        padding: 15px 0;
        font-size: 24px;
        font-weight: bold;
        z-index: 1000; /* stays above all other elements */
      }
    </style>
  </head>
  <body>
    <div id="toppingheader">
      <h1>CHIT-CHAT BOX</h1>
    </div>
    <!-- Login/Signup -->
    <div id="auth" class="auth-container">
      <h2 id="authTitle">Login</h2>
      <input type="text" id="authUsername" placeholder="Username" required />
      <input
        type="text"
        id="authFullname"
        placeholder="Full Name (Signup only)"
        class="hidden"
      />
      <input
        type="password"
        id="authPassword"
        placeholder="Password"
        required
      />
      <button onclick="handleAuth()">Login</button>
      <p><span id="toggleAuth">Don't have an account? Signup</span></p>
      <p id="authMsg" style="color: red; text-align: center"></p>
    </div>

    <!-- Chat UI -->
    <div id="chatApp" class="chat-container hidden">
      <div class="chat-contacts">
        <input
          type="text"
          id="chatSearchInput"
          placeholder="Search contacts..."
        />
        <div id="chatContacts" class="chat-contacts-list"></div>
      </div>
      <div class="chat-main">
        <div class="chat-header">
          <div id="contactAvatar" class="contact-avatar">--</div>
          <div style="flex: 1">
            <div id="contactName">Select a contact</div>
            <small id="contactStatus">Click a contact to start chatting</small>
          </div>
          <div>
            <button
              onclick="logout()"
              style="
                margin-right: 5px;
                background: #ff9800;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 5px;
                cursor: pointer;
              "
            >
              Logout
            </button>
            <button
              onclick="deleteAccount()"
              style="
                background: #e53935;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 5px;
                cursor: pointer;
              "
            >
              Delete
            </button>
          </div>
        </div>
        <div id="chatMessages" class="chat-messages"></div>
        <form id="chatForm" class="chat-footer">
          <input
            type="text"
            id="chatInput"
            placeholder="Type a message..."
            disabled
          />
          <button type="submit" disabled>Send</button>
        </form>
      </div>
    </div>

    <script>
      /* ---------------- AUTH SYSTEM ---------------- */
      let users = JSON.parse(localStorage.getItem("chatUsers"));
      if (!users || users.length === 0) {
        users = [
          {
            username: "riyanshu",
            fullName: "Riyanshu Raj Singh",
            password: "riyanshu",
            status: "online",
            lastSeen: new Date(),
          },
          {
            username: "ankit",
            fullName: "Ankit Kumar Maurya",
            password: "ankit",
            status: "online",
            lastSeen: new Date(),
          },
          {
            username: "anurag",
            fullName: "Anurag Kumar",
            password: "anurag",
            status: "offline",
            lastSeen: new Date(Date.now() - 1000 * 60 * 30),
          },
        ];
        localStorage.setItem("chatUsers", JSON.stringify(users));
      }

      let currentAccount = null;
      let conversations =
        JSON.parse(localStorage.getItem("chatConversations")) || {};

      const auth = document.getElementById("auth");
      const authTitle = document.getElementById("authTitle");
      const authUsername = document.getElementById("authUsername");
      const authFullname = document.getElementById("authFullname");
      const authPassword = document.getElementById("authPassword");
      const authMsg = document.getElementById("authMsg");
      const toggleAuth = document.getElementById("toggleAuth");
      const chatApp = document.getElementById("chatApp");

      let isLogin = true;

      toggleAuth.onclick = () => {
        isLogin = !isLogin;
        authTitle.textContent = isLogin ? "Login" : "Signup";
        document.querySelector("#auth button").textContent = isLogin
          ? "Login"
          : "Signup";
        authFullname.classList.toggle("hidden", isLogin);
        toggleAuth.textContent = isLogin
          ? "Don't have an account? Signup"
          : "Already have an account? Login";
        authMsg.textContent = "";
      };

      function handleAuth() {
        const username = authUsername.value.trim().toLowerCase();
        const fullname = authFullname.value.trim();
        const password = authPassword.value.trim();

        if (!username || !password || (!isLogin && !fullname)) {
          authMsg.textContent = "⚠️ Please fill all fields!";
          return;
        }

        let users = JSON.parse(localStorage.getItem("chatUsers"));

        if (isLogin) {
          const user = users.find(
            (u) => u.username === username && u.password === password
          );
          if (user) {
            currentAccount = user;
            startChatApp();
          } else {
            authMsg.textContent = "❌ Invalid credentials!";
          }
        } else {
          if (users.some((u) => u.username === username)) {
            authMsg.textContent = "❌ Username already exists!";
            return;
          }
          const newUser = {
            username,
            fullName: fullname,
            password,
            status: "online",
            lastSeen: new Date(),
          };
          users.push(newUser);
          localStorage.setItem("chatUsers", JSON.stringify(users));
          authMsg.style.color = "green";
          authMsg.textContent = "✅ Signup successful! Please login.";
          toggleAuth.click();
        }
      }

      function startChatApp() {
        auth.classList.add("hidden");
        chatApp.classList.remove("hidden");
        renderContacts();
      }

      /* ---------------- CHAT LOGIC ---------------- */
      const chatContacts = document.getElementById("chatContacts");
      const chatMessages = document.getElementById("chatMessages");
      const chatSearchInput = document.getElementById("chatSearchInput");
      const chatForm = document.getElementById("chatForm");
      const chatInput = document.getElementById("chatInput");
      const contactAvatar = document.getElementById("contactAvatar");
      const contactName = document.getElementById("contactName");
      const contactStatus = document.getElementById("contactStatus");

      let selectedContact = null;

      const getInitials = (name) =>
        name
          .split(" ")
          .map((n) => n[0])
          .join("")
          .toUpperCase();
      const formatChatTime = (date) =>
        `${String(date.getHours()).padStart(2, 0)}:${String(
          date.getMinutes()
        ).padStart(2, 0)}`;
      const formatLastSeen = (date) => {
        const diff = (new Date() - new Date(date)) / 60000;
        if (diff < 1) return "Just now";
        if (diff < 60) return `${Math.floor(diff)} min ago`;
        return `${Math.floor(diff / 60)} hr ago`;
      };

      function displayMessage(msg) {
        const div = document.createElement("div");
        div.classList.add(
          "message",
          msg.sender === currentAccount.username
            ? "message-sent"
            : "message-received"
        );
        div.innerHTML = `${msg.text} <br><small>${formatChatTime(
          new Date(msg.timestamp)
        )}</small>`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function renderContacts() {
        chatContacts.innerHTML = "";
        const users = JSON.parse(localStorage.getItem("chatUsers"));
        const searchTerm = chatSearchInput.value.toLowerCase();
        users
          .filter(
            (u) =>
              u.username !== currentAccount.username &&
              u.fullName.toLowerCase().includes(searchTerm)
          )
          .forEach((user) => {
            const div = document.createElement("div");
            div.className =
              "chat-contact" +
              (selectedContact?.username === user.username ? " active" : "");
            div.dataset.username = user.username;
            div.innerHTML = `
        <div class="contact-avatar">${getInitials(user.fullName)}</div>
        <div>
          <div>${user.fullName}</div>
          <small>${
            user.status === "online"
              ? "Online"
              : "Last seen " + formatLastSeen(user.lastSeen)
          }</small>
        </div>`;
            div.onclick = () => selectContact(user);
            chatContacts.appendChild(div);
          });
      }

      function selectContact(contact) {
        selectedContact = contact;
        contactAvatar.textContent = getInitials(contact.fullName);
        contactName.textContent = contact.fullName;
        contactStatus.textContent =
          contact.status === "online"
            ? "Online"
            : "Last seen " + formatLastSeen(contact.lastSeen);
        chatInput.disabled = false;
        chatForm.querySelector("button").disabled = false;
        loadConversation(contact);
      }

      function loadConversation(contact) {
        chatMessages.innerHTML = "";
        const key = getConversationKey(
          currentAccount.username,
          contact.username
        );
        if (!conversations[key]) conversations[key] = [];
        conversations[key].forEach(displayMessage);
      }

      function sendMessage(text) {
        if (!text.trim() || !selectedContact) return;
        const msg = {
          sender: currentAccount.username,
          recipient: selectedContact.username,
          text,
          timestamp: new Date(),
        };
        const key = getConversationKey(
          currentAccount.username,
          selectedContact.username
        );
        conversations[key].push(msg);
        localStorage.setItem(
          "chatConversations",
          JSON.stringify(conversations)
        );
        displayMessage(msg);
      }

      function getConversationKey(u1, u2) {
        return [u1, u2].sort().join("_");
      }

      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        sendMessage(chatInput.value);
        chatInput.value = "";
      });
      chatSearchInput.addEventListener("input", renderContacts);

      /* ---------------- Logout / Delete ---------------- */
      function logout() {
        let users = JSON.parse(localStorage.getItem("chatUsers"));
        const idx = users.findIndex(
          (u) => u.username === currentAccount.username
        );
        if (idx !== -1) {
          users[idx].status = "offline";
          users[idx].lastSeen = new Date();
          localStorage.setItem("chatUsers", JSON.stringify(users));
        }
        currentAccount = null;
        chatApp.classList.add("hidden");
        auth.classList.remove("hidden");
        authMsg.textContent = "";
        authUsername.value = "";
        authPassword.value = "";
      }

      function deleteAccount() {
        if (!currentAccount) return;
        if (
          !confirm(
            "⚠️ This will permanently delete your account and chats. Continue?"
          )
        )
          return;
        let users = JSON.parse(localStorage.getItem("chatUsers"));
        users = users.filter((u) => u.username !== currentAccount.username);
        localStorage.setItem("chatUsers", JSON.stringify(users));
        Object.keys(conversations).forEach((key) => {
          if (key.includes(currentAccount.username)) {
            delete conversations[key];
          }
        });
        localStorage.setItem(
          "chatConversations",
          JSON.stringify(conversations)
        );
        currentAccount = null;
        chatApp.classList.add("hidden");
        auth.classList.remove("hidden");
        authMsg.style.color = "green";
        authMsg.textContent = "✅ Account deleted successfully.";
        authUsername.value = "";
        authPassword.value = "";
      }
    </script>
  </body>
</html>
